{% extends "base.html" %}

{% block title %}Crear CV - CV Analyzer{% endblock %}

{% block content %}
<style>
    /* Estilos optimizados para formularios */
    .form-control {
        border: 2px solid #e3e6f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .form-control:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        background-color: #ffffff;
        outline: none;
    }
    
    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 14px;
        display: block;
    }
    
    /* Estilos para secciones dinámicas */
    .education-item, .experience-item, .language-item, .certificate-item {
        background-color: #f8f9fc;
        border: 2px solid #e3e6f0 !important;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .education-item:hover, .experience-item:hover, .language-item:hover, .certificate-item:hover {
        border-color: #4e73df !important;
        box-shadow: 0 4px 12px rgba(78, 115, 223, 0.15);
        transform: translateY(-2px);
    }
    
    /* Estilos para botones */
    .btn {
        border-radius: 8px;
        font-weight: 600;
        padding: 10px 20px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .btn-outline-primary {
        border-color: #4e73df;
        color: #4e73df;
    }
    
    .btn-outline-primary:hover {
        background-color: #4e73df;
        border-color: #4e73df;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3);
    }
    
    .btn-danger {
        background-color: #e74a3b;
        border-color: #e74a3b;
    }
    
    .btn-danger:hover {
        background-color: #c0392b;
        border-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 74, 59, 0.3);
    }
    
    /* Estilos para las secciones */
    .section {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid #e3e6f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .section h5 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #4e73df;
    }
    
    /* Estilos para skills tags */
    .skill-tag {
        background-color: #4e73df;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        margin: 4px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
    }
    
    .skill-tag:hover {
        background-color: #3d5af1;
        transform: scale(1.05);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .form-control {
            padding: 10px 14px;
            font-size: 16px;
        }
        
        .section {
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .education-item, .experience-item, .language-item, .certificate-item {
            padding: 16px;
        }
    }
</style>

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h4 class="mb-0"><i class="fas fa-file-alt"></i> Constructor de CV</h4>
                            <div class="mt-2">
                                <input type="text" id="cvName" class="form-control form-control-sm" placeholder="Nombre del CV" maxlength="100" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5);">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cv-format" id="format-ats" value="ats">
                                    <label class="form-check-label text-white" for="format-ats">
                                        Formato ATS
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cv-format" id="format-hardware" value="hardware" checked>
                                    <label class="form-check-label text-white" for="format-hardware">
                                        Formato Harvard
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-success" id="generateCV">
                                <i class="fas fa-save"></i> Generar CV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Formulario -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-edit"></i> Información del CV</h5>
                </div>
                <div class="card-body">
                    <form id="cvForm">
                        <!-- Información Personal -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Información Personal</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre Completo *</label>
                                    <input type="text" class="form-control" id="name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="phone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="address">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">LinkedIn</label>
                                    <input type="url" class="form-control" id="linkedin" placeholder="https://linkedin.com/in/tu-perfil">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">GitHub</label>
                                    <input type="url" class="form-control" id="github" placeholder="https://github.com/tu-usuario">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Portafolio/Sitio Web</label>
                                    <input type="url" class="form-control" id="website" placeholder="https://tu-sitio-web.com">
                                </div>
                            </div>
                        </div>

                        <!-- Resumen Profesional -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Resumen Profesional</h5>
                            <div class="mb-3">
                                <label class="form-label">Resumen Profesional</label>
                                <textarea class="form-control" id="professionalSummary" rows="4" placeholder="Describe brevemente tu experiencia, habilidades clave y objetivos profesionales..."></textarea>
                                <div class="form-text">Un resumen conciso de 2-3 líneas que destaque tu experiencia y valor único.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Metodologías de IA para Resumen</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="summaryMethodology" id="summaryXYZ" value="xyz">
                                            <label class="form-check-label" for="summaryXYZ" title="eXperience, Years, Zeal - Destaca experiencia específica, años de trayectoria y pasión">
                                                <strong>XYZ</strong>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="summaryMethodology" id="summarySTAR" value="star">
                                            <label class="form-check-label" for="summarySTAR" title="Situation, Task, Action, Result - Estructura con situación, tarea, acción y resultado">
                                                <strong>STAR</strong>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="summaryMethodology" id="summaryNone" value="none" checked>
                                            <label class="form-check-label" for="summaryNone">
                                                <strong>Ninguna</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Experiencia -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Experiencia Profesional</h5>
                            <div class="mb-3">
                                <label class="form-label">Metodologías de IA para Experiencia</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="experienceMethodology" id="experienceXYZ" value="xyz">
                                            <label class="form-check-label" for="experienceXYZ" title="eXperience, Years, Zeal - Enfoque en innovación y tecnologías emergentes">
                                                <strong>XYZ</strong>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="experienceMethodology" id="experienceSTAR" value="star">
                                            <label class="form-check-label" for="experienceSTAR" title="Situation, Task, Action, Result - Describe situación, tarea, acciones y resultados">
                                                <strong>STAR</strong>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="experienceMethodology" id="experienceNone" value="none" checked>
                                            <label class="form-check-label" for="experienceNone">
                                                <strong>Ninguna</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="experienceContainer">
                                <div class="experience-item border p-3 mb-3 rounded">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Cargo *</label>
                                            <input type="text" class="form-control experience-position" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Empresa *</label>
                                            <input type="text" class="form-control experience-company" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Inicio</label>
                                            <input type="month" class="form-control experience-start-date">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Fin</label>
                                            <input type="month" class="form-control experience-end-date">
                                            <div class="form-check mt-2">
                                                <input class="form-check-input experience-current" type="checkbox">
                                                <label class="form-check-label">Trabajo actual</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Descripción</label>
                                        <textarea class="form-control experience-description" rows="3"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger remove-experience" style="display: none;">Eliminar</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addExperience">
                                <i class="fas fa-plus"></i> Agregar Experiencia
                            </button>
                        </div>

                        <!-- Habilidades -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Habilidades</h5>
                            <div class="mb-3">
                                <label class="form-label">Agregar Habilidad</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="skillInput" placeholder="Ej: JavaScript, Liderazgo, etc.">
                                    <button type="button" class="btn btn-outline-primary" id="addSkill">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="skillsContainer" class="d-flex flex-wrap gap-2"></div>
                        </div>

                        <!-- Educación -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Educación</h5>
                            <div id="educationContainer">
                                <div class="education-item border p-3 mb-3 rounded">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Carrera *</label>
                                            <input type="text" class="form-control education-career" required placeholder="Ej: Ingeniería en Sistemas">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Institución *</label>
                                            <input type="text" class="form-control education-institution" required placeholder="Ej: Universidad Nacional">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Año de Ingreso</label>
                                            <input type="number" class="form-control education-start-year" min="1950" max="2030" placeholder="2020">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Año de Egreso</label>
                                            <input type="number" class="form-control education-end-year" min="1950" max="2030" placeholder="2024">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger remove-education" style="display: none;">Eliminar</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addEducation">
                                <i class="fas fa-plus"></i> Agregar Educación
                            </button>
                        </div>

                        <!-- Certificados -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Certificados</h5>
                            <div id="certificatesContainer">
                                <div class="certificate-item border p-3 mb-3 rounded">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Título del Certificado</label>
                                            <input type="text" class="form-control certificate-title" placeholder="Ej: Certificación AWS">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Institución</label>
                                            <input type="text" class="form-control certificate-institution" placeholder="Ej: Amazon Web Services">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Obtención</label>
                                            <input type="month" class="form-control certificate-date">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger remove-certificate" style="display: none;">Eliminar</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addCertificate">
                                <i class="fas fa-plus"></i> Agregar Certificado
                            </button>
                        </div>

                        <!-- Idiomas -->
                        <div class="section mb-4">
                            <h5 class="text-primary border-bottom pb-2">Idiomas</h5>
                            <div id="languagesContainer">
                                <div class="language-item border p-3 mb-3 rounded">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Idioma</label>
                                            <input type="text" class="form-control language-name" placeholder="Ej: Inglés">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nivel</label>
                                            <select class="form-control language-level">
                                                <option value="">Seleccionar nivel</option>
                                                <option value="Básico">Básico</option>
                                                <option value="Intermedio">Intermedio</option>
                                                <option value="Avanzado">Avanzado</option>
                                                <option value="Nativo">Nativo</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger remove-language" style="display: none;">Eliminar</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addLanguage">
                                <i class="fas fa-plus"></i> Agregar Idioma
                            </button>
                        </div>

                        <!-- Indicador de guardado automático -->
                        <div class="text-center">
                            <small id="saveIndicator" class="text-muted"></small>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Vista Previa -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-eye"></i> Vista Previa</h4>
                </div>
                <div class="card-body">
                    <div id="cvPreview" class="border p-3" style="min-height: 600px; background: white; font-family: 'Times New Roman', serif;">
                        <div class="text-center text-muted">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p>La vista previa aparecerá aquí mientras completas el formulario</p>
                        </div>
                    </div>
                    <div class="mt-3 d-grid">
                        <button type="button" class="btn btn-outline-success" id="exportPdf" disabled>
                            <i class="fas fa-download"></i> Descargar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cvId = null;
let skills = [];
let autoSaveTimeout;
let lastSaveData = '';

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    setupEventListeners();
    updateRemoveButtons();
});

// Configurar event listeners
function setupEventListeners() {
    // Botones principales
    document.getElementById('generateCV').addEventListener('click', generateCV);
    document.getElementById('exportPdf').addEventListener('click', exportPdf);
    
    // Botones de agregar elementos
    document.getElementById('addExperience').addEventListener('click', addExperience);
    document.getElementById('addEducation').addEventListener('click', addEducation);
    document.getElementById('addCertificate').addEventListener('click', addCertificate);
    document.getElementById('addLanguage').addEventListener('click', addLanguage);
    document.getElementById('addSkill').addEventListener('click', addSkill);
    
    // Habilidades
    document.getElementById('skillInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addSkill();
        }
    });
    
    // Actualización en tiempo real
    document.addEventListener('input', function(e) {
        updatePreview();
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(autoSave, 2000);
    });
    
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('experience-current')) {
            const endDateInput = e.target.closest('.experience-item').querySelector('.experience-end-date');
            endDateInput.disabled = e.target.checked;
            if (e.target.checked) endDateInput.value = '';
        }
        updatePreview();
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(autoSave, 500);
    });
    
    // Guardar antes de cerrar
    window.addEventListener('beforeunload', function(e) {
        const currentData = JSON.stringify(collectFormData());
        if (currentData !== lastSaveData) {
            navigator.sendBeacon('/save_cv_draft', new Blob([currentData], {type: 'application/json'}));
        }
    });
}

// Funciones para agregar elementos
function addExperience() {
    const container = document.getElementById('experienceContainer');
    const newItem = container.children[0].cloneNode(true);
    clearFormInputs(newItem);
    newItem.querySelector('.remove-experience').style.display = 'inline-block';
    container.appendChild(newItem);
    updateRemoveButtons();
    updatePreview();
}

function addEducation() {
    const container = document.getElementById('educationContainer');
    const newItem = container.children[0].cloneNode(true);
    clearFormInputs(newItem);
    newItem.querySelector('.remove-education').style.display = 'inline-block';
    container.appendChild(newItem);
    updateRemoveButtons();
    updatePreview();
}

function addCertificate() {
    const container = document.getElementById('certificatesContainer');
    const newItem = container.children[0].cloneNode(true);
    clearFormInputs(newItem);
    newItem.querySelector('.remove-certificate').style.display = 'inline-block';
    container.appendChild(newItem);
    updateRemoveButtons();
    updatePreview();
}

function addLanguage() {
    const container = document.getElementById('languagesContainer');
    const newItem = container.children[0].cloneNode(true);
    clearFormInputs(newItem);
    newItem.querySelector('.remove-language').style.display = 'inline-block';
    container.appendChild(newItem);
    updateRemoveButtons();
    updatePreview();
}

function addSkill() {
    const input = document.getElementById('skillInput');
    const skill = input.value.trim();
    
    if (skill && !skills.includes(skill)) {
        skills.push(skill);
        updateSkillsDisplay();
        input.value = '';
        updatePreview();
    }
}

// Funciones auxiliares
function clearFormInputs(element) {
    element.querySelectorAll('input, textarea, select').forEach(input => {
        if (input.type === 'checkbox') {
            input.checked = false;
        } else {
            input.value = '';
        }
    });
}

function updateRemoveButtons() {
    const sections = ['education', 'experience', 'language', 'certificate'];
    
    sections.forEach(section => {
        const items = document.querySelectorAll(`.${section}-item`);
        items.forEach((item, index) => {
            const removeBtn = item.querySelector(`.remove-${section}`);
            if (items.length > 1) {
                removeBtn.style.display = 'inline-block';
                removeBtn.onclick = () => {
                    item.remove();
                    updateRemoveButtons();
                    updatePreview();
                };
            } else {
                removeBtn.style.display = 'none';
            }
        });
    });
}

function updateSkillsDisplay() {
    const container = document.getElementById('skillsContainer');
    container.innerHTML = '';
    
    skills.forEach((skill, index) => {
        const badge = document.createElement('span');
        badge.className = 'skill-tag';
        badge.innerHTML = `${skill} <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick="removeSkill(${index})"></button>`;
        container.appendChild(badge);
    });
}

function removeSkill(index) {
    skills.splice(index, 1);
    updateSkillsDisplay();
    updatePreview();
}

// Recopilar datos del formulario
function collectFormData() {
    const data = {
        cv_name: document.getElementById('cvName').value || 'Mi CV',
        personal_info: {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            linkedin: document.getElementById('linkedin').value,
            github: document.getElementById('github').value,
            website: document.getElementById('website').value
        },
        professional_summary: document.getElementById('professionalSummary').value,
        ai_methodologies: {
            summary_methodology: document.querySelector('input[name="summaryMethodology"]:checked')?.value || 'none',
            experience_methodology: document.querySelector('input[name="experienceMethodology"]:checked')?.value || 'none'
        },
        education: [],
        experience: [],
        skills: skills,
        languages: [],
        certificates: [],
        format_options: {
            format: document.querySelector('input[name="cv-format"]:checked').value
        }
    };
    
    // Recopilar educación
    document.querySelectorAll('.education-item').forEach(item => {
        const career = item.querySelector('.education-career').value;
        const institution = item.querySelector('.education-institution').value;
        if (career && institution) {
            data.education.push({
                career: career,
                institution: institution,
                start_year: item.querySelector('.education-start-year').value,
                end_year: item.querySelector('.education-end-year').value
            });
        }
    });
    
    // Recopilar experiencia
    document.querySelectorAll('.experience-item').forEach(item => {
        const position = item.querySelector('.experience-position').value;
        const company = item.querySelector('.experience-company').value;
        if (position && company) {
            const isCurrent = item.querySelector('.experience-current').checked;
            data.experience.push({
                position: position,
                company: company,
                start_date: item.querySelector('.experience-start-date').value,
                end_date: isCurrent ? 'Presente' : item.querySelector('.experience-end-date').value,
                description: item.querySelector('.experience-description').value,
                current: isCurrent
            });
        }
    });
    
    // Recopilar idiomas
    document.querySelectorAll('.language-item').forEach(item => {
        const language = item.querySelector('.language-name').value;
        const level = item.querySelector('.language-level').value;
        if (language) {
            data.languages.push({
                language: language,
                level: level
            });
        }
    });
    
    // Recopilar certificados
    document.querySelectorAll('.certificate-item').forEach(item => {
        const title = item.querySelector('.certificate-title').value;
        if (title) {
            data.certificates.push({
                title: title,
                institution: item.querySelector('.certificate-institution').value,
                date: item.querySelector('.certificate-date').value
            });
        }
    });
    
    return data;
}

// Actualizar vista previa
function updatePreview() {
    const cvData = collectFormData();
    const preview = document.getElementById('cvPreview');
    
    if (!cvData.personal_info.name) {
        preview.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <p>La vista previa aparecerá aquí mientras completas el formulario</p>
            </div>
        `;
        return;
    }
    
    const isAtsFormat = cvData.format_options.format === 'ats';
    const headerStyle = isAtsFormat 
        ? 'text-align: left; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 20px;' 
        : 'text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;';
    
    const nameStyle = isAtsFormat 
        ? 'font-size: 18px; font-weight: bold; margin-bottom: 5px;' 
        : 'font-size: 24px; font-weight: bold; margin-bottom: 5px;';
    
    const sectionTitleStyle = isAtsFormat 
        ? 'font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px;' 
        : 'font-size: 14px; font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 10px;';
    
    let contactInfo = [cvData.personal_info.email, cvData.personal_info.phone, cvData.personal_info.address].filter(Boolean).join(' | ');
    
    let socialLinks = [];
    if (cvData.personal_info.linkedin) socialLinks.push(`LinkedIn: ${cvData.personal_info.linkedin}`);
    if (cvData.personal_info.github) socialLinks.push(`GitHub: ${cvData.personal_info.github}`);
    if (cvData.personal_info.website) socialLinks.push(`Web: ${cvData.personal_info.website}`);
    
    let html = `
        <div style="${headerStyle}">
            <div style="${nameStyle}">${cvData.personal_info.name}</div>
            <div style="font-size: 12px;">${contactInfo}</div>
            ${socialLinks.length > 0 ? `<div style="font-size: 11px; margin-top: 5px;">${socialLinks.join(' | ')}</div>` : ''}
        </div>
    `;
    
    // Resumen profesional
    if (cvData.professional_summary && cvData.professional_summary.trim()) {
        html += `
            <div style="margin-bottom: 20px;">
                <div style="${sectionTitleStyle}">RESUMEN PROFESIONAL</div>
                <div style="text-align: justify; line-height: 1.4;">${cvData.professional_summary}</div>
            </div>
        `;
    }
    
    // Educación
    if (cvData.education.length > 0) {
        html += `<div style="margin-bottom: 20px;"><div style="${sectionTitleStyle}">EDUCACIÓN</div>`;
        cvData.education.forEach(edu => {
            const yearRange = edu.start_year && edu.end_year ? `${edu.start_year} - ${edu.end_year}` : 
                             edu.start_year ? `${edu.start_year} - Presente` : 
                             edu.end_year ? `Hasta ${edu.end_year}` : '';
            html += `
                <div style="margin-bottom: 10px;">
                    <div style="float: right;">${yearRange}</div>
                    <div style="font-weight: bold;">${edu.career}</div>
                    <div style="font-style: italic;">${edu.institution}</div>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Experiencia
    if (cvData.experience.length > 0) {
        html += `<div style="margin-bottom: 20px;"><div style="${sectionTitleStyle}">EXPERIENCIA PROFESIONAL</div>`;
        cvData.experience.forEach(exp => {
            html += `
                <div style="margin-bottom: 10px;">
                    <div style="float: right;">${exp.start_date} - ${exp.end_date}</div>
                    <div style="font-weight: bold;">${exp.position}</div>
                    <div style="font-style: italic;">${exp.company}</div>
                    ${exp.description ? `<div>${exp.description}</div>` : ''}
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Habilidades
    if (skills.length > 0) {
        html += `<div style="margin-bottom: 20px;"><div style="${sectionTitleStyle}">HABILIDADES</div>`;
        if (isAtsFormat) {
            html += `<div>${skills.join(', ')}</div>`;
        } else {
            html += `<div style="display: flex; flex-wrap: wrap; gap: 10px;">`;
            skills.forEach(skill => {
                html += `<span style="background: #f0f0f0; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${skill}</span>`;
            });
            html += `</div>`;
        }
        html += `</div>`;
    }
    
    // Idiomas
    if (cvData.languages.length > 0) {
        html += `<div style="margin-bottom: 20px;"><div style="${sectionTitleStyle}">IDIOMAS</div>`;
        cvData.languages.forEach(lang => {
            if (lang.language) {
                html += `<div>${lang.language} - ${lang.level}</div>`;
            }
        });
        html += `</div>`;
    }
    
    // Certificados
    if (cvData.certificates.length > 0) {
        html += `<div style="margin-bottom: 20px;"><div style="${sectionTitleStyle}">CERTIFICADOS</div>`;
        cvData.certificates.forEach(cert => {
            if (cert.title) {
                html += `
                    <div style="margin-bottom: 10px;">
                        <div style="float: right;">${cert.date || ''}</div>
                        <div style="font-weight: bold;">${cert.title}</div>
                        <div style="font-style: italic;">${cert.institution || ''}</div>
                    </div>
                `;
            }
        });
        html += `</div>`;
    }
    
    preview.innerHTML = html;
}

// Funciones de guardado y carga
function generateCV() {
    const cvData = collectFormData();
    
    // Incluir cv_id si estamos editando un CV existente
    const urlParams = new URLSearchParams(window.location.search);
    const cvId = urlParams.get('cv_id');
    if (cvId) {
        cvData.cv_id = cvId;
    }
    
    if (!cvData.personal_info.name || !cvData.personal_info.email) {
        alert('Por favor completa al menos el nombre y email.');
        return;
    }
    
    if (cvData.education.length === 0) {
        alert('Por favor agrega al menos una educación.');
        return;
    }
    
    if (cvData.experience.length === 0) {
        alert('Por favor agrega al menos una experiencia.');
        return;
    }
    
    fetch('/save_cv', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cvData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar variable global y URL
            window.cvId = data.cv_id;
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('cv_id', data.cv_id);
            window.history.replaceState({}, '', newUrl);
            
            document.getElementById('exportPdf').disabled = false;
            alert(data.message || 'CV guardado exitosamente!');
            
            if (data.improved_data) {
                if (data.improved_data.professional_summary) {
                    document.getElementById('professionalSummary').value = data.improved_data.professional_summary;
                }
                
                if (data.improved_data.experience) {
                    const experienceItems = document.querySelectorAll('.experience-item');
                    data.improved_data.experience.forEach((exp, index) => {
                        if (experienceItems[index] && exp.description) {
                            experienceItems[index].querySelector('.experience-description').value = exp.description;
                        }
                    });
                }
                
                updatePreview();
            }
        } else {
            alert('Error al guardar CV: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar CV');
    });
}



function autoSave() {
    const formData = collectFormData();
    const urlParams = new URLSearchParams(window.location.search);
    const cvId = urlParams.get('cv_id');
    
    if (cvId) formData.cv_id = cvId;
    
    const currentData = JSON.stringify(formData);
    
    // Verificar si hay contenido significativo antes de guardar
    const hasSignificantContent = (
        (formData.personal_info && formData.personal_info.name && formData.personal_info.name.trim()) ||
        (formData.professional_summary && formData.professional_summary.trim()) ||
        (formData.education && formData.education.length > 0 && formData.education[0].degree) ||
        (formData.experience && formData.experience.length > 0 && formData.experience[0].position) ||
        (formData.skills && formData.skills.length > 0) ||
        (formData.languages && formData.languages.length > 0) ||
        (formData.certificates && formData.certificates.length > 0)
    );
    
    // Solo guardar si hay contenido significativo y hay cambios
    if (currentData !== lastSaveData && (cvId || hasSignificantContent)) {
        lastSaveData = currentData;
        
        fetch('/save_cv_draft', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: currentData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.cv_id && !cvId) {
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('cv_id', data.cv_id);
                    window.history.replaceState({}, '', newUrl);
                }
                
                const saveIndicator = document.getElementById('saveIndicator');
                if (saveIndicator) {
                    saveIndicator.textContent = 'Guardado automáticamente';
                    saveIndicator.style.color = '#28a745';
                    setTimeout(() => saveIndicator.textContent = '', 2000);
                }
            }
        })
        .catch(error => console.error('Error en guardado automático:', error));
    }
}

function loadUserData() {
    const urlParams = new URLSearchParams(window.location.search);
    const editingCvId = urlParams.get('cv_id');
    
    console.log('loadUserData called, editingCvId:', editingCvId);
    
    // Establecer cvId global si estamos editando
    if (editingCvId) {
        cvId = editingCvId;
        console.log('Set global cvId to:', cvId);
    }
    
    let url = '/get_user_cv_data';
    if (editingCvId) url += `?cv_id=${editingCvId}`;
    
    console.log('Fetching data from:', url);
    
    fetch(url)
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Received result:', result);
        
        if (result.success && result.data) {
            const data = result.data;
            console.log('CV data to load:', data);
            
            // Cargar datos básicos
            if (data.cv_name) {
                const cvNameInput = document.getElementById('cvName');
                if (cvNameInput) {
                    cvNameInput.value = data.cv_name;
                    console.log('Set CV name:', data.cv_name);
                } else {
                    console.warn('cvName input not found');
                }
            }
            
            if (data.personal_info) {
                console.log('Loading personal info:', data.personal_info);
                const pi = data.personal_info;
                
                if (pi.name) {
                    const nameInput = document.getElementById('name');
                    if (nameInput) {
                        nameInput.value = pi.name;
                        console.log('Set name:', pi.name);
                    } else {
                        console.warn('name input not found');
                    }
                }
                
                if (pi.email) {
                    const emailInput = document.getElementById('email');
                    if (emailInput) emailInput.value = pi.email;
                }
                if (pi.phone) {
                    const phoneInput = document.getElementById('phone');
                    if (phoneInput) phoneInput.value = pi.phone;
                }
                if (pi.address) {
                    const addressInput = document.getElementById('address');
                    if (addressInput) addressInput.value = pi.address;
                }
                if (pi.linkedin) {
                    const linkedinInput = document.getElementById('linkedin');
                    if (linkedinInput) linkedinInput.value = pi.linkedin;
                }
                if (pi.github) {
                    const githubInput = document.getElementById('github');
                    if (githubInput) githubInput.value = pi.github;
                }
                if (pi.website) {
                    const websiteInput = document.getElementById('website');
                    if (websiteInput) websiteInput.value = pi.website;
                }
            }
            
            if (data.professional_summary) {
                const summaryInput = document.getElementById('professionalSummary');
                if (summaryInput) {
                    summaryInput.value = data.professional_summary;
                    console.log('Set professional summary:', data.professional_summary);
                } else {
                    console.warn('professionalSummary input not found');
                }
            }
            
            // Cargar metodologías de IA
            if (data.ai_methodologies) {
                console.log('Loading AI methodologies:', data.ai_methodologies);
                const methodologies = data.ai_methodologies;
                
                // Cargar metodología de resumen
                if (methodologies.summary_methodology) {
                    const summaryRadio = document.querySelector(`input[name="summaryMethodology"][value="${methodologies.summary_methodology}"]`);
                    if (summaryRadio) {
                        summaryRadio.checked = true;
                        console.log('Set summary methodology:', methodologies.summary_methodology);
                    }
                }
                
                // Cargar metodología de experiencia
                if (methodologies.experience_methodology) {
                    const experienceRadio = document.querySelector(`input[name="experienceMethodology"][value="${methodologies.experience_methodology}"]`);
                    if (experienceRadio) {
                        experienceRadio.checked = true;
                        console.log('Set experience methodology:', methodologies.experience_methodology);
                    }
                }
            }
            
            if (data.format_options && data.format_options.format) {
                const formatRadio = document.querySelector(`input[name="cv-format"][value="${data.format_options.format}"]`);
                if (formatRadio) {
                    formatRadio.checked = true;
                    console.log('Set format:', data.format_options.format);
                }
            }
            
            // Cargar secciones dinámicas
            console.log('Loading dynamic sections...');
            if (data.education) {
                console.log('Loading education data:', data.education);
                loadSectionData('education', data.education);
            }
            if (data.experience) {
                console.log('Loading experience data:', data.experience);
                loadSectionData('experience', data.experience);
            }
            if (data.languages) {
                console.log('Loading languages data:', data.languages);
                loadSectionData('languages', data.languages);
            }
            if (data.certificates) {
                console.log('Loading certificates data:', data.certificates);
                loadSectionData('certificates', data.certificates);
            }
            
            // Habilitar botón de exportar PDF si estamos editando un CV existente
            if (editingCvId) {
                const exportButton = document.getElementById('exportPdf');
                if (exportButton) {
                    exportButton.disabled = false;
                    console.log('Export button enabled for CV:', editingCvId);
                }
            }
            
            if (data.skills && data.skills.length > 0) {
                skills = data.skills;
                updateSkillsDisplay();
                console.log('Loaded skills:', data.skills);
            }
            
            updatePreview();
            lastSaveData = JSON.stringify(collectFormData());
            
            // Habilitar botón de exportar PDF si estamos editando un CV existente
            if (cvId) {
                const exportButton = document.getElementById('exportPdf');
                if (exportButton) {
                    exportButton.disabled = false;
                }
            }
            
            console.log('Data loading completed successfully');
        } else {
            console.error('Invalid response or no data:', result);
            if (result.error) {
                console.error('Server error:', result.error);
            }
        }
    })
    .catch(error => {
        console.error('Error al cargar datos del usuario:', error);
        // Mostrar mensaje de error al usuario
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            Error al cargar los datos del CV: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        const container = document.querySelector('.container');
        if (container) {
            container.insertBefore(alertDiv, container.firstChild);
        }
    });
}

function loadSectionData(sectionName, sectionData) {
    if (!sectionData || sectionData.length === 0) return;
    
    // Mapear nombres de sección a nombres de contenedor
    const containerMap = {
        'education': 'educationContainer',
        'experience': 'experienceContainer', 
        'languages': 'languagesContainer',
        'certificates': 'certificatesContainer'
    };
    
    const containerId = containerMap[sectionName];
    if (!containerId) {
        console.error(`No se encontró contenedor para la sección: ${sectionName}`);
        return;
    }
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`No se encontró el elemento con ID: ${containerId}`);
        return;
    }
    
    // Limpiar contenedor excepto el primer elemento
    while (container.children.length > 1) {
        container.removeChild(container.lastChild);
    }
    
    sectionData.forEach((item, index) => {
        let sectionItem;
        if (index === 0) {
            sectionItem = container.children[0];
        } else {
            sectionItem = container.children[0].cloneNode(true);
            // Mapear nombres de botón de eliminar
            const removeButtonMap = {
                'education': '.remove-education',
                'experience': '.remove-experience',
                'languages': '.remove-language',
                'certificates': '.remove-certificate'
            };
            const removeButtonSelector = removeButtonMap[sectionName];
            if (removeButtonSelector) {
                const removeButton = sectionItem.querySelector(removeButtonSelector);
                if (removeButton) {
                    removeButton.style.display = 'inline-block';
                }
            }
            container.appendChild(sectionItem);
        }
        
        // Llenar datos específicos por sección
        try {
            if (sectionName === 'education') {
                if (item.career) {
                    const careerInput = sectionItem.querySelector('.education-career');
                    if (careerInput) careerInput.value = item.career;
                }
                if (item.institution) {
                    const institutionInput = sectionItem.querySelector('.education-institution');
                    if (institutionInput) institutionInput.value = item.institution;
                }
                if (item.start_year) {
                    const startYearInput = sectionItem.querySelector('.education-start-year');
                    if (startYearInput) startYearInput.value = item.start_year;
                }
                if (item.end_year) {
                    const endYearInput = sectionItem.querySelector('.education-end-year');
                    if (endYearInput) endYearInput.value = item.end_year;
                }
            } else if (sectionName === 'experience') {
                if (item.position) {
                    const positionInput = sectionItem.querySelector('.experience-position');
                    if (positionInput) positionInput.value = item.position;
                }
                if (item.company) {
                    const companyInput = sectionItem.querySelector('.experience-company');
                    if (companyInput) companyInput.value = item.company;
                }
                if (item.start_date) {
                    const startDateInput = sectionItem.querySelector('.experience-start-date');
                    if (startDateInput) startDateInput.value = item.start_date;
                }
                if (item.end_date) {
                    const endDateInput = sectionItem.querySelector('.experience-end-date');
                    if (endDateInput) endDateInput.value = item.end_date;
                }
                if (item.description) {
                    const descriptionInput = sectionItem.querySelector('.experience-description');
                    if (descriptionInput) descriptionInput.value = item.description;
                }
                if (item.current) {
                    const currentCheckbox = sectionItem.querySelector('.experience-current');
                    const endDateInput = sectionItem.querySelector('.experience-end-date');
                    if (currentCheckbox) {
                        currentCheckbox.checked = true;
                        if (endDateInput) endDateInput.disabled = true;
                    }
                }
            } else if (sectionName === 'languages') {
                if (item.language) {
                    const languageInput = sectionItem.querySelector('.language-name');
                    if (languageInput) languageInput.value = item.language;
                }
                if (item.level) {
                    const levelInput = sectionItem.querySelector('.language-level');
                    if (levelInput) levelInput.value = item.level;
                }
            } else if (sectionName === 'certificates') {
                if (item.title) {
                    const titleInput = sectionItem.querySelector('.certificate-title');
                    if (titleInput) titleInput.value = item.title;
                }
                if (item.institution) {
                    const institutionInput = sectionItem.querySelector('.certificate-institution');
                    if (institutionInput) institutionInput.value = item.institution;
                }
                if (item.date) {
                    const dateInput = sectionItem.querySelector('.certificate-date');
                    if (dateInput) dateInput.value = item.date;
                }
            }
        } catch (error) {
            console.error(`Error cargando datos para ${sectionName}:`, error, item);
        }
    });
    
    updateRemoveButtons();
}

function exportPdf() {
    // Obtener cv_id de la URL si estamos editando, o usar la variable global cvId
    const urlParams = new URLSearchParams(window.location.search);
    const currentCvId = urlParams.get('cv_id') || window.cvId;
    
    if (currentCvId) {
        window.open(`/export_cv/${currentCvId}`, '_blank');
    } else {
        alert('Primero debes generar el CV antes de poder descargarlo.');
    }
}
</script>
{% endblock %}