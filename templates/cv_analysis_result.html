{% extends "base.html" %}

{% block title %}Resultados del Análisis - CV Analyzer Pro{% endblock %}

{% block extra_css %}
<style>
    /* Mejorar visibilidad de elementos con bordes prominentes */
    .score-circle {
        background-color: #ffffff !important;
        color: #2c3e50 !important;
        border: 4px solid #3498db !important;
        font-weight: 900 !important;
        text-shadow: none;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    
    .card {
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
        border: 3px solid #007bff !important;
        border-radius: 15px !important;
        background-color: #ffffff !important;
    }
    
    .card-header {
        font-weight: 600;
        border-radius: 12px 12px 0 0 !important;
        border-bottom: 2px solid rgba(255,255,255,0.3) !important;
    }
    
    /* Elementos de análisis con bordes prominentes y texto visible */
    .strength-item, .weakness-item, .recommendation-item {
        border: 3px solid #010202 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        border-radius: 8px !important;
    }
    
    .weakness-item {
        border: 3px solid #010202 !important;
    }
    
    .recommendation-item {
        border: 3px solid #010202 !important;
    }
    
    .strength-item p, .weakness-item p, .recommendation-item p {
        color: #212529 !important;
        font-weight: 600 !important;
        font-size: 15px !important;
        line-height: 1.6 !important;
        margin: 0 !important;
    }
    
    /* Asegurar visibilidad de iconos */
    .strength-item i, .weakness-item i, .recommendation-item i {
        opacity: 1 !important;
    }
    
    .badge {
        font-weight: 700 !important;
        font-size: 13px !important;
        padding: 8px 12px !important;
        border: 2px solid rgba(255,255,255,0.3) !important;
    }
    
    .tip-card {
        border: 2px solid #dee2e6 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        border-radius: 8px !important;
    }
    
    /* Mejorar visibilidad de palabras clave */
    .keyword-badge {
        border: 2px solid #e9ecef !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important;
        border-radius: 6px !important;
    }
    
    /* Mejorar contraste en gráficos */
    canvas {
        background-color: #ffffff;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .progress-bar {
        background-color: #3498db !important;
        color: #ffffff !important;
        font-weight: 600;
    }
    
    /* Asegurar que todos los números sean visibles */
    h4, h5, .display-4, .display-5 {
        color: #2c3e50 !important;
        font-weight: 700 !important;
    }
    
    .text-white h4, .text-white h5 {
        color: #ffffff !important;
        font-weight: 700 !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3) !important;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(251deg, #667eea 0%, #0e1721 100%) !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        border-radius: 15px !important;
    }
    
    .bg-gradient-primary .score-circle {
        background-color: #ffffff !important;
        color: #667eea !important;
        border: 4px solid #ffffff !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
    }
    
    /* Mejorar visibilidad de números en tarjetas */
    .bg-gradient-primary .card-body h4 {
        font-size: 2.5rem !important;
        font-weight: 800 !important;
        color: #ffffff !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.4) !important;
    }
    
    .bg-gradient-primary .card-body p {
        font-weight: 600 !important;
        color: rgba(255,255,255,0.9) !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-2">
                        <i class="fas fa-chart-line me-2 text-success"></i>Resultados del Análisis
                    </h2>
                    <p class="text-muted mb-0">
                        Análisis completo de tu currículum realizado por nuestro sistema de IA
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('analyze_cv') }}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-plus me-2"></i>Nuevo Análisis
                    </a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Score Overview -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body py-4">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="score-circle bg-white text-primary d-inline-flex align-items-center justify-content-center mb-3" 
                                 style="width: 120px; height: 120px; font-size: 2.5rem; font-weight: bold;">
                                {{ (analysis.score or 0) | default(0) }}%
                            </div>
                            <h5 class="mb-0">Puntuación General</h5>
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-4 text-center mb-3">
                                    <h4 class="mb-1">{{ analysis.strengths|length }}</h4>
                                    <p class="mb-0">Fortalezas Identificadas</p>
                                </div>
                                <div class="col-md-4 text-center mb-3">
                                    <h4 class="mb-1">{{ analysis.weaknesses|length }}</h4>
                                    <p class="mb-0">Áreas de Mejora</p>
                                </div>
                                <div class="col-md-4 text-center mb-3">
                                    <h4 class="mb-1">{{ analysis.recommendations|length }}</h4>
                                    <p class="mb-0">Recomendaciones</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress" style="height: 20px; background-color: rgba(255,255,255,0.3); border-radius: 10px;">
                                    <div class="progress-bar" 
                                         style="width: {{ (analysis.score or 0) | default(0) }}%; background-color: #ffffff; color: #667eea; font-weight: 700; text-shadow: none;" 
                                         id="scoreProgress">
                                        {{ (analysis.score or 0) | default(0) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Analysis -->
    <div class="row">
        <!-- Strengths -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-thumbs-up me-2"></i>Fortalezas
                    </h5>
                </div>
                <div class="card-body">
                    {% if analysis.strengths %}
                        {% for strength in analysis.strengths %}
                        <div class="strength-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="fas fa-check-circle text-success fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">{{ strength }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-search fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No se identificaron fortalezas específicas</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Weaknesses -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Áreas de Mejora
                    </h5>
                </div>
                <div class="card-body">
                    {% if analysis.weaknesses %}
                        {% for weakness in analysis.weaknesses %}
                        <div class="weakness-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="fas fa-exclamation-circle text-warning fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">{{ weakness }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-trophy fa-2x text-muted mb-3"></i>
                            <p class="text-muted">¡Excelente! No se encontraron debilidades significativas</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Recomendaciones
                    </h5>
                </div>
                <div class="card-body">
                    {% if analysis.recommendations %}
                        {% for recommendation in analysis.recommendations %}
                        <div class="recommendation-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="fas fa-arrow-right text-info fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">{{ recommendation }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-star fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Tu CV está en excelente forma</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="row mb-5">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Distribución de Puntuación
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="scoreChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Análisis por Categorías
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Keywords Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tags me-2"></i>Palabras Clave Recomendadas
                    </h5>
                </div>
                <div class="card-body">
                    {% if analysis.keywords and analysis.keywords|length > 0 %}
                    <div class="row">
                        {% for keyword in analysis.keywords %}
                        <div class="col-md-3 col-sm-4 col-6 mb-3">
                            <div class="keyword-badge p-2 bg-light rounded text-center">
                                <span class="badge bg-primary p-2">{{ keyword }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 small text-muted">
                        <i class="fas fa-info-circle me-1"></i> Incluye estas palabras clave en tu CV para mejorar tu visibilidad en los sistemas ATS.
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No se identificaron palabras clave específicas</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-4">
                    <h5 class="mb-4">¿Qué quieres hacer ahora?</h5>
                    <div class="row justify-content-center">
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('create_cv') }}" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-file-alt fa-2x mb-2 d-block"></i>
                                Crear Nuevo CV
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('analyze_cv') }}" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-robot fa-2x mb-2 d-block"></i>
                                Analizar Otro CV
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('job_search') }}" class="btn btn-info btn-lg w-100">
                                <i class="fas fa-search fa-2x mb-2 d-block"></i>
                                Buscar Empleos
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button onclick="downloadReport()" class="btn btn-warning btn-lg w-100">
                                <i class="fas fa-download fa-2x mb-2 d-block"></i>
                                Descargar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Improvement Tips -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Consejos para Mejorar tu Puntuación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="tip-card p-3 border rounded">
                                <h6 class="text-primary">
                                    <i class="fas fa-key me-2"></i>Optimiza las Palabras Clave
                                </h6>
                                <p class="small text-muted mb-0">
                                    Incluye términos específicos de tu industria y las habilidades mencionadas en las ofertas de trabajo que te interesan.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="tip-card p-3 border rounded">
                                <h6 class="text-success">
                                    <i class="fas fa-chart-line me-2"></i>Cuantifica tus Logros
                                </h6>
                                <p class="small text-muted mb-0">
                                    Usa números, porcentajes y métricas específicas para demostrar el impacto de tu trabajo.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="tip-card p-3 border rounded">
                                <h6 class="text-info">
                                    <i class="fas fa-align-left me-2"></i>Mejora el Formato
                                </h6>
                                <p class="small text-muted mb-0">
                                    Usa un diseño limpio, consistente y fácil de leer. Evita fuentes decorativas y colores excesivos.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="tip-card p-3 border rounded">
                                <h6 class="text-warning">
                                    <i class="fas fa-check-double me-2"></i>Revisa la Ortografía
                                </h6>
                                <p class="small text-muted mb-0">
                                    Asegúrate de que no haya errores ortográficos o gramaticales. Usa herramientas de corrección.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animate score progress bar
        const scoreProgress = document.getElementById('scoreProgress');
        const targetWidth = parseInt("{{ (analysis.score or 0) | default(0) }}", 10);
        
        setTimeout(() => {
            scoreProgress.style.transition = 'width 2s ease-in-out';
            scoreProgress.style.width = targetWidth + '%';
        }, 500);
        
        // Score Distribution Chart
        const scoreCtx = document.getElementById('scoreChart').getContext('2d');
        const score = parseInt("{{ (analysis.score or 0) | default(0) }}", 10);
        const remaining = 100 - score;
        
        new Chart(scoreCtx, {
            type: 'doughnut',
            data: {
                labels: ['Puntuación Obtenida', 'Margen de Mejora'],
                datasets: [{
                    data: [score, remaining],
                    backgroundColor: [
                        score >= 80 ? '#28a745' : score >= 60 ? '#ffc107' : '#dc3545',
                        '#e9ecef'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#2c3e50',
                            font: {
                                size: 14,
                                weight: '600'
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
        
        // Category Analysis Chart
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        
        // Simulate category scores based on overall score
        const baseScore = parseInt("{{ (analysis.score or 0) | default(0) }}", 10);
        const categories = {
            'Experiencia': Math.min(100, baseScore + Math.random() * 20 - 10),
            'Habilidades': Math.min(100, baseScore + Math.random() * 20 - 10),
            'Educación': Math.min(100, baseScore + Math.random() * 20 - 10),
            'Formato': Math.min(100, baseScore + Math.random() * 20 - 10),
            'Palabras Clave': Math.min(100, baseScore + Math.random() * 20 - 10)
        };
        
        new Chart(categoryCtx, {
            type: 'radar',
            data: {
                labels: Object.keys(categories),
                datasets: [{
                    label: 'Tu Puntuación',
                    data: Object.values(categories),
                    backgroundColor: 'rgba(52, 152, 219, 0.3)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(52, 152, 219, 1)',
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            color: '#2c3e50',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        pointLabels: {
                            color: '#2c3e50',
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        },
                        grid: {
                            color: 'rgba(44, 62, 80, 0.2)'
                        },
                        angleLines: {
                            color: 'rgba(44, 62, 80, 0.2)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Animate cards on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);
        
        // Observe analysis items
        document.querySelectorAll('.strength-item, .weakness-item, .recommendation-item').forEach(item => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            item.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(item);
        });
    });
    
    // Download report function
    function downloadReport() {
        // Create a simple text report
        const score = parseInt("{{ (analysis.score or 0) | default(0) }}", 10);
        const strengths = JSON.parse('{{ analysis.strengths | tojson | safe }}');
        const weaknesses = JSON.parse('{{ analysis.weaknesses | tojson | safe }}');
        const recommendations = JSON.parse('{{ analysis.recommendations | tojson | safe }}');
        const keywords = {{ analysis.keywords | tojson | safe }};
        
        let report = "REPORTE DE ANÁLISIS DE CV\n";
        report += "================================\n\n";
        report += "PUNTUACIÓN GENERAL: " + score + "%\n\n";
        
        report += "FORTALEZAS:\n";
        strengths.forEach(function(strength, index) {
            report += (index + 1) + ". " + strength + "\n";
        });
        
        report += "\nÁREAS DE MEJORA:\n";
        weaknesses.forEach(function(weakness, index) {
            report += (index + 1) + ". " + weakness + "\n";
        });
        
        report += "\nRECOMENDACIONES:\n";
        recommendations.forEach(function(recommendation, index) {
            report += (index + 1) + ". " + recommendation + "\n";
        });
        
        report += "\nPALABRAS CLAVE RECOMENDADAS:\n";
        if (keywords && keywords.length > 0) {
            keywords.forEach(function(keyword, index) {
                report += (index + 1) + ". " + keyword + "\n";
            });
        } else {
            report += "No se identificaron palabras clave específicas.\n";
        }
        
        report += "\n\nGenerado por CV Analyzer Pro\n";
        report += "Fecha: " + new Date().toLocaleDateString('es-ES');
        
        // Create and download file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "reporte_analisis_cv_" + new Date().getTime() + ".txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}